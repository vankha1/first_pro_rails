<%= form_with(model: @album, class: "row", style: "width: 100%", local: true) do |f| %>
    <div class="col-6">
        <%= f.label :title %><br/>
        <%= f.text_field :title, placeholder: "Photo Title", style: "width: 90%; margin-bottom: 1.5rem" %>

        <%= f.label :sharing_mode %><br/>
        <%= f.select :is_private, ['Public', 'Private'] %>
    </div>

    <div class="col-6">
        <%= f.label :description %><br/>
        <%= f.text_area :description, placeholder: "Photo Description", size: "50x5", style: "width: 90%; margin-bottom: 1.5rem" %>
    </div>

    <div id="thumbnail-container" class="d-flex flex-wrap" style="gap: 1.5rem">
        <%= f.fields_for :photos do |photo| %>
            <%= render "albums/photo_fields", f: photo %>
        <% end %>
        <div class='links'>
            <%= link_to_add_association raw('<i
            class="fa-solid fa-plus"
            style="
                font-size: 4rem;
                -webkit-text-stroke: 5px #bdbdbd;
                color: #bdbdbd;
            "
        ></i>'), f, :photos, class: "card text-white border-1 p-0 mt-4 mb-5 d-flex justify-content-center align-items-center text-decoration-none", style:   "width: 200px;
                                height: 200px;
                                background-color: #f2f2f2;
                                border-style: dashed;
                                cursor: pointer;" %>
        </div>
    </div>

    <div>
        <%= f.submit "Save", class: "btn btn-success", style: "margin-right: 3rem" %>
    </div>
<% end %>

<script>
    $(document).on('ready', () => {
        $('div.nested-fields:first').hide()
        $('.links').on('cocoon:before-insert', () => {
            $('div.nested-fields:first input[type=hidden]').prop('disabled', true)
            $('#files_inputs').click();
        })
        // Find the last nested field and add the image preview to it
        handle_preview($("#files_inputs"), $("div.nested-fields:last #card-img"));
    })

    function readURL(input, image) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                $("div.nested-fields:last #card-img").attr('src', e.target.result);
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function handle_preview(input_tag, image){
        input_tag.change(function(e){
            if (this.files.length){
                var file = this.files[0];
                readURL(this, image);
            }
            else {
                $("div.nested-fields:last #card-img").remove();
            }
        });
    }
</script>